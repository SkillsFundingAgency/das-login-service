# ![crest](https://assets.publishing.service.gov.uk/government/assets/crests/org_crest_27px-916806dcf065e7273830577de490d5c7c42f36ddec83e907efe62086785f24fb.png) Digital Apprenticeships Service

##  Employer Users Service

###  Migration to Login Service

The users which have already been created in the Employer Users service can be migrated to the Login Service whilst retaining their
current passwords.

Script: (src\SFA.DAS.LoginService.Database\ManualScripts\MigrateEmployerUsers.sql)

Run the script connected to the instance of the Employer Users Service database which is to be migrated; the script will output
SQL INSERT statements for each user which is to be migrated.

Save the output to a file / clipboard and connect to the Login Service database to which the user are to be migrated; run the output
SQL INSERT statements which have been generated.

#### Scenarios

A user which is to be migrated may be in various states in the Employer Users Service database.

	1. User has confirmed their email in Employer Users Service and is signing in via the Login service with a migrated user 
	   => Login will succeed, the password will be hashed in new .Net Core password hash format.

	2. User has not confirmed their email in Employer Users Service and is signing in via the Login service with a migrated user
	   => Login will not succeed, the user will be given a message asking them to confirm their email, they will be reminded to
	   disregard any previous emails (which may have been generated by Employer Users Service), as these will no longer be valid.

	3. User is partially locked out e.g. 2/3 attempts made whilst in the Employer Users Service.
	   => User can continue to attempt logins in Login service upto the Login Service limit (currently 10 attempts before lockout)
	
	4. User is locked out in Employer Users Service
	  => Login will not succeed the standard user is locked out flow will apply when logging into the Login Service i.e. must reset password.

	5. User has not confirmed their email in Employer Users Service and is currently locked out and is logging in via the Login Service with a migrated user
	   => Login will not succeed the standard user is locked out flow will apply when logging into the Login service i.e. must reset password.
	   => After user changes their password they will not have confirmed their email
	      Login will not succeed, the user will be given a message asking them to confirm their email, they will be reminded to
	   disregard any previous emails (which may have been generated by Employer Users Service), as these will no longer be valid.

	6. User is an existing user in Logon service that was invited prior to the migration;
	  => Login will succeed as the user has been updated to be Email confirmed during the deployment of the database prior to migration.
	  
#### Email Confirmation

	 In the EmployerUsers service the user creates a login, entering their name, email and password; the user then receives a code and link via email; they follow the link enter the 
	 code and activate their account.
	  
	 In the LoginService the user is currently invited to the service so this itself is validating their email; they reply to the email and enter their password (there is no code)

	 If a user is migrated to the new system with an unconfirmed email, they would possibly reply to their previously sent confirmation link.

	 The Link e.g. 'https://accounts.at-eas.apprenticeships.education.gov.uk/service/register/new' sends them back to Manage Apprentices
	 where they are redirected back to the IdentityServer (EmployerUsers) as this is a link which needs authorization; this will after migration 
	 send them to the Login service where they would need to confirm their email by using a new confirmation link; as such the message which
	 prompts the user to confirm their email will remind them to disregard current email confirmation.


###  Sample Applications

There are two sample application included which demonstrate.

1. Connection to standard Open-Id authentication server (Login Service)

2. Create Account as internal flow of the Login Service, linked from sign-in page.

3. Create Account as internal flow of the Login Service, linked directly from client application.